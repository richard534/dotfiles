* Init.el
#+BEGIN_SRC emacs-lisp
;;; init.el.org --- my emacs configuration -*- lexical-binding: t; -*-
#+END_SRC
** Use-package
#+BEGIN_SRC emacs-lisp
(unless (package-installed-p 'use-package)
  (package-refresh-contents)
  (package-install 'use-package))
(require 'use-package)
#+END_SRC
** Diminish
#+begin_src emacs-lisp
(use-package diminish
  :ensure t)
#+end_src
** Language and encoding
Add UTF-8 to the front of the priority list for automatic detection
#+BEGIN_SRC emacs-lisp
(prefer-coding-system 'utf-8)
#+END_SRC
Set up mulilingual environment to use UTF-8
#+BEGIN_SRC emacs-lisp
(set-language-environment "UTF-8")
#+END_SRC
Set default value of various coding systems to UTF-8
#+BEGIN_SRC emacs-lisp
(set-default-coding-systems 'utf-8)
#+END_SRC
** Emacs UI
Disable gui toolbar
#+BEGIN_SRC emacs-lisp
(tool-bar-mode -1)
#+END_SRC
Disable mac menubar
#+BEGIN_SRC emacs-lisp
(menu-bar-mode -1)
#+END_SRC
Disable scrollbar
#+BEGIN_SRC emacs-lisp
(toggle-scroll-bar -1)
#+END_SRC
Prevent the cursor from blinking
#+BEGIN_SRC emacs-lisp
(blink-cursor-mode 0)
#+END_SRC
Initial scratch message
#+BEGIN_SRC emacs-lisp
(setq initial-scratch-message "")
#+END_SRC
Disable startup screen
#+BEGIN_SRC emacs-lisp
(setq inhibit-startup-screen t)
#+END_SRC
Don't let Emacs hurt your ears
#+BEGIN_SRC emacs-lisp
(setq visible-bell t)
#+END_SRC
Overwrite default emacs startup message
#+BEGIN_SRC emacs-lisp
(defun display-startup-echo-area-message ()
  (message nil))
#+END_SRC
Number of lines to scroll when reach top/bottom of window
#+BEGIN_SRC emacs-lisp
(setq scroll-step 1)
#+END_SRC
turn off all alarms (flashing bottom of screen, audible)
#+BEGIN_SRC emacs-lisp
(setq ring-bell-function 'ignore)
#+END_SRC
set left fringe width - prevent vertical splits hiding diff-hl
#+BEGIN_SRC emacs-lisp
;; (setq-default left-fringe-width 16)
#+END_SRC
Remove icons/text from title bar (transparent title bar)
#+BEGIN_SRC emacs-lisp
(add-to-list 'default-frame-alist '(ns-transparent-titlebar . t))
(add-to-list 'default-frame-alist '(ns-appearance . dark)) ;; assuming you are using a dark theme
(setq ns-use-proxy-icon nil)
(setq frame-title-format
      `((buffer-file-name "%f" "%b")
        ,(format " - GNU Emacs %s" emacs-version)))
#+END_SRC
** Theme
#+BEGIN_SRC emacs-lisp
(use-package doom-themes
  :ensure t
  :init
  ; Global settings (defaults)
  (setq doom-themes-enable-bold t    ; if nil, bold is universally disabled
      doom-themes-enable-italic t) ; if nil, italics is universally disabled

  :config
  ; Load the theme (doom-one, doom-molokai, etc)
  (load-theme 'doom-vibrant t)
  ; Corrects (and improves) org-mode's native fontification.
  (doom-themes-org-config)
  ; overload doom-themes "selected region" color
  (set-face-attribute 'region nil :background "#666"))
#+END_SRC
** Font
Set default font
#+BEGIN_SRC emacs-lisp
(set-default-font "Source Code Pro 15")
#+END_SRC
** Tabs
#+begin_src emacs-lisp
;; Some variables in Emacs are "buffer-local", meaning that each buffer is allowed to have a separate value for that variable that overrides the global default
;; If a variable is buffer-local, then setq sets its local value in the current buffer and setq-default sets the global default value.
;; If a variable is not buffer-local, then setq and setq-default do the same thing.
;; https://stackoverflow.com/a/18173666/5298275

(setq-default
  tab-always-indent nil ; make TAB insert tabulation/spaces instead of indenting
  indent-tabs-mode nil ; Pressing tab will produce spaces instead of tab chars
  tab-width 2 ; *Display* tabs as x spaces (they are still tab characters - they just looks like x spaces in the editor)
  c-basic-offset 2 ; Num spaces to idnent for c-based modes (php, java, etc)
  tab-stop-list (number-sequence 2 60 2))
#+end_src
** Word wrapping
Word wrapping mode hooks
#+BEGIN_SRC emacs-lisp
; Text mode
(add-hook 'prog-mode-hook '(lambda ()
    (visual-line-mode -1)
    (setq truncate-lines t
          word-wrap nil)))

; Programming mode
(add-hook 'text-mode-hook '(lambda ()
    (setq truncate-lines nil
          word-wrap t)))
#+END_SRC
** Misc Text Editor Settings
Set lines to wrap at certain char limit
#+BEGIN_SRC emacs-lisp
(setq-default fill-column 120)
#+END_SRC
Delete trailing whitespace on save
#+BEGIN_SRC emacs-lisp
(add-hook 'before-save-hook 'delete-trailing-whitespace)
#+END_SRC
Insert newline at the end of all files - if not already present
#+BEGIN_SRC emacs-lisp
(setq-default require-final-newline t)
#+END_SRC
** Backup
#+BEGIN_SRC emacs-lisp
(setq backup-directory-alist `(("~/.emacs-saves")))
(setq version-control t     ;; Use version numbers for backups.
      kept-new-versions 10  ;; Number of newest versions to keep.
      kept-old-versions 0   ;; Number of oldest versions to keep.
      delete-old-versions t ;; Don't ask to delete excess backup versions.
      backup-by-copying t)  ;; Copy all files, don't rename them.

(setq make-backup-files nil) ; stop creating backup~ files
(setq auto-save-default nil) ; stop creating #autosave# files
#+END_SRC
** Custom
#+BEGIN_SRC emacs-lisp
(use-package custom
  :after evil-collection
  :config
  (setq custom-file "~/.emacs.d/custom.el")
  (load custom-file 'noerror)
  (evil-collection-custom-setup))
#+END_SRC
** Info
#+BEGIN_SRC emacs-lisp
(use-package info
  :after evil-collection
  :config
  (evil-collection-info-setup))
#+END_SRC
** Exec-path-from-shell
On OS X, an Emacs instance started from the graphical user
interface will have a different environment than a shell in a
terminal window, because OS X does not run a shell during the
login. This will lead to unexpected results when
calling external utilities like make from Emacs.

The exec-path-from-shell library works around this problem by copying important
environment variables from the user's shell.
#+BEGIN_SRC emacs-lisp
(if (eq system-type 'darwin)

    (use-package exec-path-from-shell
      :ensure t
      :config

      (when (memq window-system '(mac ns x))
        (exec-path-from-shell-initialize)))


  ; Focus on emacs session when opening emacs gui
  (when (featurep 'ns)
    (defun ns-raise-emacs ()
      "Raise Emacs."
      (ns-do-applescript "tell application \"Emacs\" to activate"))

    (defun ns-raise-emacs-with-frame (frame)
      "Raise Emacs and select the provided frame."
      (with-selected-frame frame
        (when (display-graphic-p)
          (ns-raise-emacs))))

    (add-hook 'after-make-frame-functions 'ns-raise-emacs-with-frame)

    (when (display-graphic-p)
      (ns-raise-emacs))))
#+END_SRC
** Evil
#+BEGIN_SRC emacs-lisp
(use-package evil
  :ensure t ;; install the evil package if not installed
  :diminish undo-tree-mode
  :init ;; configure evil before loading it
  ;; Variables required by evil-collection
  (setq evil-want-integration t) ; This is optional since it's already set to t by default.
  (setq evil-want-keybinding nil)

  ; set evil search implementation to internal evil-search (instead of isearch)
  (setq evil-search-module 'evil-search)

  ; When visual-selecting to end of line ($), select until end of line - not whole line
  (setq evil-want-visual-char-semi-exclusive t)

  ; disable evil auto indent
  (setq evil-auto-indent nil)

  ; Make evil treat underscore '_' seperated words as a single word
  (defalias #'forward-evil-word #'forward-evil-symbol)
  (setq-default evil-symbol-word-search t)

  :config ;; configure evil after loading it
  (evil-mode 1)

  ; Rebind keys for vim-like crtl-u pgUp
  (define-key evil-visual-state-map (kbd "C-u") 'evil-scroll-up)
  ; Motion state is an Evil-specific thing, intended for modes where you don't edit text. E.g help buffers
  (define-key evil-motion-state-map (kbd "C-u") 'evil-scroll-up)

  ; Goto git hunks
  (define-key evil-normal-state-map "g]" `diff-hl-next-hunk)
  (define-key evil-normal-state-map "g[" `diff-hl-previous-hunk)
  ; Add goto git hunks to evil jump-list (allows crtl-o/i navigation between git-hunk commands)
  (evil-add-command-properties #'diff-hl-next-hunk :jump t)
  (evil-add-command-properties #'diff-hl-previous-hunk :jump t)

  ; configure evil cursor
  (setq evil-emacs-state-cursor '("red" box))
  (setq evil-normal-state-cursor '("green" box))
  (setq evil-visual-state-cursor '("orange" box))
  (setq evil-insert-state-cursor '("red" bar))
  (setq evil-replace-state-cursor '("red" bar))
  (setq evil-operator-state-cursor '("red" hollow))

  ;; Select all keybind
  (fset 'select-all
     "ggVG")
  (define-key evil-normal-state-map (kbd "C-a") 'select-all)

  ;; Bind evil ex-commands
  ; Bind evil ex-command to open init file
  (evil-ex-define-cmd "init" #'find-emacs-init-file)
  (evil-ex-define-cmd "reload" #'reload-init-file)
  ; :q deletes window - keeps buffer
  (evil-ex-define-cmd "q" 'delete-window)
  ; :quit closes emacs
  (evil-ex-define-cmd "quit" 'save-buffers-kill-emacs)
  ; vs vertically splits window
  (evil-ex-define-cmd "vs" (lambda () (interactive)(split-window-horizontally) (other-window 1)))
  ; sp horizontally splits window
  (evil-ex-define-cmd "sp" (lambda () (interactive)(split-window-vertically) (other-window 1)))

  ;; Add commands to evil jump-list
  (evil-add-command-properties #'anzu-query-replace-at-cursor :jump t)
  (evil-add-command-properties #'projectile-replace :jump t))
#+END_SRC
** Evil-collection
#+BEGIN_SRC emacs-lisp
(use-package evil-collection
  :after (evil)
  :ensure t)
#+END_SRC
** Evil-escape
#+BEGIN_SRC emacs-lisp
(use-package evil-escape
  :ensure t
  :diminish evil-escape-mode
  :init
  (setq-default evil-escape-key-sequence "jk")
  (setq-default evil-escape-delay 0.2)
  :config
  (evil-escape-mode t))
#+END_SRC
** Evil-leader
#+BEGIN_SRC emacs-lisp
(use-package evil-leader
  :ensure t
  :config
  (global-evil-leader-mode)
  (evil-leader/set-leader "<SPC>")
  (evil-leader/set-key
    "<SPC>" 'counsel-M-x
    "r" `anzu-query-replace-at-cursor ; buffer-wide find/replace
    "R"  `projectile-replace ; project-wide find/replace
    "is" `yas-insert-snippet ; insert snippet
    "fd" `magit-file-dispatch ; file-dispatch (magit command)
    "[" `winner-undo
    "]" `winner-redo
    "fj" `json-pretty-print
    "fJ" `json-pretty-print-buffer

    ;; Universal argument (u)
    "u" 'universal-argument

    ;; Text (x)
    ; Inflection (i)
    "xii"  `string-inflection-all-cycle
    "xiu" 'string-inflection-underscore
    "xiU" 'string-inflection-upcase
    "xik" 'string-inflection-kebab-case
    "xic" 'string-inflection-lower-camelcase
    "xiC" 'string-inflection-camelcas

    ; Align (a)
    "xaa" 'align
    "xar" 'align-regexp
    "xac" 'align-current

    ;; Region narrowing (n)
    "nr" 'narrow-to-region
    "np" 'narrow-to-page
    "nf" 'narrow-to-defun
    "nw" 'widen

    ;; File (f)
    "fR" 'rename-file-and-buffer ; rename file and buffer
    "fD" 'delete-current-buffer-file ; Delete a file and assoc. buffer
    "fS" 'evil-write-all
    "fs" 'save-buffer
    "fy" 'copy-file-name-to-clipboard
    "fY" 'show-and-copy-buffer-file-abs-path

    ;; Buffers (b)
    "bd" 'kill-current-buffer
    "bm" 'kill-other-buffers
    "bn" 'next-buffer
    "bp" 'previous-buffer
    "bR" 'revert-buffer-no-confirm
    "bw" 'read-only-mode
    "bb" 'counsel-switch-buffer
    "bx" 'kill-buffer-and-window ; buffer - kill

    ;; Window (w)
    "ww"    'other-window
    "w TAB" 'alternate-window
    "w="    'balance-windows
    "wd"    'delete-window

    ; Shrink/Enlarge
    "w[" (lambda () (interactive (shrink-window-horizontally 1)))
    "w]" (lambda () (interactive (enlarge-window-horizontally 1)))
    "w{" (lambda () (interactive (shrink-window-vertically 1)))
    "w}" (lambda () (interactive (enlarge-window-vertically 1)))

    ; Selection/Movement (hjkl)
    "wH"    'evil-window-move-far-left
    "wh"    'evil-window-left
    "wJ"    'evil-window-move-very-bottom
    "wj"    'evil-window-down
    "wK"    'evil-window-move-very-top
    "wk"    'evil-window-up
    "wL"    'evil-window-move-far-right
    "wl"    'evil-window-right

    ; Maximize (m)
    "wm"    'toggle-maximize-buffer

    ; Open window-manipulation hydra (.)
    "w."    'hydra-window-manipulation/body

    ; Rotation (r)
    "wr"    'rotate-windows-forward
    "wR"    'rotate-windows-backward

    ; Horizontal Split (s)
    "ws"    'split-window-below
    "wS"    'split-window-below-and-focus

    ; Vertical Split (v)
    "wv"    'split-window-right
    "wV"    'split-window-right-and-focus

    ;; GUI Toggles (t)
    "tl" 'toggle-truncate-lines
    "tL" 'visual-line-mode
    "tn" 'display-line-numbers-mode)


  (defhydra hydra-window-manipulation
    (:color pink :hint nil)
"
 Select^^^^               Move^^^^              Split^^               Resize^^             Other^^
 ──────^^^^─────────────  ────^^^^────────────  ─────^^─────────────  ──────^^───────────  ─────^^──────────────────
 [_j_/_k_]  down/up       [_J_/_K_] down/up     [_s_] vertical        [_[_] shrink horiz   [_u_] restore prev layout
 [_h_/_l_]  left/right    [_H_/_L_] left/right  [_S_] verti & follow  [_]_] enlarge horiz  [_U_] restore next layout
 [_0_.._9_] window 0..9   [_r_]^^   rotate fwd  [_v_] horizontal      [_{_] shrink verti   [_d_] close current
 [_w_]^^    other window  [_R_]^^   rotate bwd  [_V_] horiz & follow  [_}_] enlarge verti  [_D_] close other
 [_o_]^^    other frame   ^^^^                  ^^                    ^^
 [_q_] quit
"

  ("q" nil :exit t)
  ("0" winum-select-window-0)
  ("1" winum-select-window-1)
  ("2" winum-select-window-2)
  ("3" winum-select-window-3)
  ("4" winum-select-window-4)
  ("5" winum-select-window-5)
  ("6" winum-select-window-6)
  ("7" winum-select-window-7)
  ("8" winum-select-window-8)
  ("9" winum-select-window-9)
  ("-" split-window-below-and-focus)
  ("/" split-window-right-and-focus)
  ("[" (lambda () (interactive) (shrink-window-horizontally 1)))
  ("]" (lambda () (interactive (enlarge-window-horizontally 1))))
  ("{" (lambda () (interactive (shrink-window-vertically 1))))
  ("}" (lambda () (interactive (enlarge-window-vertically 1))))
  ("d" delete-window)
  ("D" delete-other-windows)
  ("h" evil-window-left)
  ("j" evil-window-down)
  ("k" evil-window-up)
  ("l" evil-window-right)
  ("H" evil-window-move-far-left)
  ("J" evil-window-move-very-bottom)
  ("K" evil-window-move-very-top)
  ("L" evil-window-move-far-right)
  ("o" other-frame)
  ("r" rotate-windows-forward)
  ("R" rotate-windows-backward)
  ("s" split-window-below)
  ("S" split-window-below-and-focus)
  ("u" winner-undo)
  ("U" winner-redo)
  ("v" split-window-right)
  ("V" split-window-right-and-focus)
  ("w" other-window)))
#+END_SRC
** Evil-nerd-commenter
#+begin_src emacs-lisp
(use-package evil-nerd-commenter
  :ensure t
  :after evil-leader
  :init
  (evil-leader/set-key
    "ci" 'evilnc-comment-or-uncomment-lines
    "cl" 'evilnc-quick-comment-or-uncomment-to-the-line
    "ll" 'evilnc-quick-comment-or-uncomment-to-the-line
    "cc" 'evilnc-copy-and-comment-lines
    "cp" 'evilnc-comment-or-uncomment-paragraphs
    "cr" 'comment-or-uncomment-region
    "cv" 'evilnc-toggle-invert-comment-line-by-line
    "."  'evilnc-copy-and-comment-operator))
#+end_src
** Evil-magit
#+BEGIN_SRC emacs-lisp
(use-package evil-magit
  :ensure t)
#+END_SRC
** Evil-surround
#+BEGIN_SRC emacs-lisp
(use-package evil-surround
  :ensure t
  :config
  (global-evil-surround-mode 1))
#+END_SRC
** Evil-number
#+BEGIN_SRC emacs-lisp
(use-package evil-numbers
  :ensure t
  :init
  (global-set-key (kbd "C-=") 'evil-numbers/inc-at-pt)
  (global-set-key (kbd "C--") 'evil-numbers/dec-at-pt))
#+END_SRC
** Evil-visualstar
#+BEGIN_SRC emacs-lisp
(use-package evil-visualstar
  :ensure t
  :after evil
  :init
  (global-evil-visualstar-mode))
#+END_SRC
** Evil-anzu
#+BEGIN_SRC emacs-lisp
(use-package evil-anzu
  :ensure t
  :after evil)
#+END_SRC
** Anzu
#+BEGIN_SRC emacs-lisp
(use-package anzu
  :ensure t
  :diminish anzu-mode
  :init
  (global-anzu-mode +1)
  (setq anzu-search-threshold 1000
    anzu-cons-mode-line-p nil))
#+END_SRC
** Help
#+BEGIN_SRC emacs-lisp
(use-package help
  :after evil-collection
  :init
  (setq help-window-select t) ; Always select (focus on) the help window when opened
  :config
  ;; Help-mode related keybindings
  (evil-collection-help-setup)
  (evil-leader/set-key "hdb" 'describe-bindings)
  (evil-leader/set-key "hdf" 'describe-function)
  (evil-leader/set-key "hdv" 'describe-variable)
  (evil-leader/set-key "hdk" 'describe-key)
  (evil-leader/set-key "hdp" 'describe-package)
  (evil-leader/set-key "hdm" 'describe-mode))
#+END_SRC
** Elisp-Mode
#+begin_src emacs-lisp
(use-package elisp-mode
  :hook elisp-mode
  :init
  (evil-leader/set-key-for-mode 'emacs-lisp-mode
    "mer" 'eval-region
    "meb" 'eval-buffer))
#+end_src
** Line numbers
#+BEGIN_SRC emacs-lisp
; Enable line numbers only in modes that inherit prog-mode (programming mode)
(add-hook 'prog-mode-hook 'display-line-numbers-mode 1)
; groovy-mode-hook doesn't seem to inherit prog-mode - defining seperately
(add-hook 'groovy-mode-hook 'display-line-numbers-mode 1)
#+END_SRC
** Package
#+BEGIN_SRC emacs-lisp
(use-package package
  :config
  ; Evilify keybinds
  (evil-add-hjkl-bindings package-menu-mode-map 'emacs
    (kbd "/")       'evil-search-forward
    (kbd "?")       'evil-search-backward
    (kbd "n")       'evil-search-next
    (kbd "N")       'evil-search-previous
    (kbd "C-d")     'evil-scroll-down
    (kbd "C-u")     'evil-scroll-up
    (kbd "gg")      'evil-goto-first-line
    (kbd "gb")      'counsel-switch-buffer
    (kbd "G")       'evil-goto-line
    (kbd "^")       'evil-first-non-blank))
#+END_SRC
** Sql
#+begin_src emacs-lisp
(use-package sql
  :mode ("\\.sql\\'" . sql-mode)
  :init
  (evil-leader/set-key-for-mode
    'sql-mode

    ;; listing (l)
    "mla" 'sql-list-all
    "mlt" 'sql-list-table

    ;; sqli buffer (b)
    "mbb" 'sql-show-sqli-buffer
    "mbs" 'sql-set-sqli-buffer

    ;; interactivity (s)
    ; start
    "msi" 'sql-start

    ; send
    "msq" 'sql-send-string
    "msf" 'sql-send-paragraph
    "msl" 'sql-send-line-and-next
    "msr" 'sql-send-region
    "msb" 'sql-send-buffer)

  (evil-leader/set-key-for-mode
    'sql-interactive-mode

    ;; sqli buffer
    "mbr" 'sql-rename-buffer
    "mbS" 'sql-save-connection)

    :config
    ; Add prompt for port when connecting to postgres
    (setq sql-postgres-login-params (append sql-postgres-login-params '(port)))

    ; Improved prumpt regex's
    ; https://www.emacswiki.org/emacs/SqlMode
    (sql-set-product-feature 'postgres :prompt-regexp "^[-[:alnum:]_]*=[#>] ")
    (sql-set-product-feature 'postgres :prompt-cont-regexp
                           "^[-[:alnum:]_]*[-(][#>] ")

    (add-hook 'sql-interactive-mode-hook
        (lambda () (toggle-truncate-lines t))))
#+end_src
** Electric
Auto-complete pairs of brackets/quotes etc.
#+BEGIN_SRC emacs-lisp
(setq electric-pair-preserve-balance nil)
#+END_SRC
Disabled "electric indent mode" - breaks some modes inc. python
#+BEGIN_SRC emacs-lisp
(electric-indent-mode -1)
#+END_SRC
** Winum
#+begin_src emacs-lisp
(use-package winum
  :ensure t
  :init
  (winum-mode)
  ; Bind evil-leader keys
  (evil-leader/set-key
    "1" 'winum-select-window-1
    "2" 'winum-select-window-2
    "3" 'winum-select-window-3
    "4" 'winum-select-window-4
    "5" 'winum-select-window-5
    "6" 'winum-select-window-6
    "7" 'winum-select-window-7
    "8" 'winum-select-window-8
    "9" 'winum-select-window-9))
#+end_src
** Dired
#+BEGIN_SRC emacs-lisp
(use-package dired
  :after evil-collection
  :init
  (evil-leader/set-key
    "ad" 'dired
    "fj" 'dired-jump
    "jd" 'dired-jump
    "jD" 'dired-jump-other-window)

  ;; Auto-refresh dired on file change
  (add-hook 'dired-mode-hook 'auto-revert-mode)
  :config
  (evil-collection-dired-setup))
#+END_SRC
** Dired-narrow
#+begin_src emacs-lisp
(use-package dired-narrow
  :ensure t
  :after dired
  :init
  (evil-define-key 'normal dired-mode-map
    "/" 'dired-narrow))
#+end_src
** Dired-collapse
#+begin_src emacs-lisp
(use-package dired-collapse
  :ensure t
  :after dired)
#+end_src
** Dired-ranger
#+begin_src emacs-lisp
(use-package dired-ranger
  :ensure t
  :after dired
  :init
  (evil-define-key 'normal dired-mode-map
    "/" 'dired-narrow)

  (evil-define-key 'normal dired-mode-map
    "yy" 'dired-ranger-copy
    "pp" 'dired-ranger-paste
    "pP" 'dired-ranger-move))
#+end_src
** Wdired
#+begin_src emacs-lisp
(use-package wdired
  :init
  (evil-collection-wdired-setup))
#+end_src
** Vc
#+begin_src emacs-lisp
(use-package vc
  :init
  (setq auto-revert-check-vc-info t))
#+end_src
** Eldoc
#+BEGIN_SRC emacs-lisp
(use-package eldoc
  :diminish eldoc-mode)
#+END_SRC
** Auto revert
Emacs auto-reloads buffers when files change on disk.
#+BEGIN_SRC emacs-lisp
; Auto refresh buffers that have changed on disk
(global-auto-revert-mode 1)
; auto refresh non-file buffers (like dired)
(setq global-auto-revert-non-file-buffers t)
; Silence auto-revert messages
(setq auto-revert-verbose nil)
#+END_SRC
** Saveplace
Remember cursor position of files when reopening them
#+BEGIN_SRC emacs-lisp
(save-place-mode 1)
#+END_SRC
** Winner
enable winner mode
#+BEGIN_SRC emacs-lisp
(winner-mode 1)
#+END_SRC
** Abbrev
#+BEGIN_SRC emacs-lisp
(use-package abbrev
  :diminish abbrev-mode)
#+END_SRC
** Emacs Server
start emacs-server (for use with emacsclient)
#+BEGIN_SRC emacs-lisp
(server-start)
#+END_SRC
** Org
#+begin_src emacs-lisp
(use-package org
  :diminish org-mode
  :init
  (setq org-startup-indented t) ; turn on ‘org-indent-mode’ on startup.
  (eval-after-load 'org-indent '(diminish 'org-indent-mode)) ; diminish ‘org-indent-mode’ on load

  (setq org-hide-leading-stars t) ; hide orgmode heading stars
  (setq org-adapt-indentation nil) ; hide orgmode heading indented stars
  (setq org-hide-emphasis-markers t) ; hide bold bullet points etc
  (setq org-src-preserve-indentation t) ; preserve leading whitespace on export (prevents adding leading spaces to editied blocks)
  (setq org-cycle-include-plain-lists 'integrate) ; When running org-cycle plain list items will be treated like low-level headlines (will cycle)
  (setq org-M-RET-may-split-line '((item . nil))) ; in the context of a list of items; goto eol before making a new line
  (setq org-confirm-babel-evaluate nil) ; Disable asking for confirmation when executing babel code block for all languages

  ; org-goto related config
  (setq org-goto-interface 'outline-path-completion)
  (setq org-outline-path-complete-in-steps nil)

  ; org-mode images related config
  (setq org-startup-with-inline-images t) ; Show inline images by default
  (setq org-image-actual-width nil) ; try to get the width from an #+ATTR.* keyword and fall back on the original width if none is found.

  ; Set colour of org bold (*) markup to red
  (add-to-list 'org-emphasis-alist
	       '("*" (:foreground "red")))

  ; evil-leader org-mode bindings
  (evil-leader/set-key-for-mode
    'org-mode
        "m'"  'org-edit-special
        "mt"  'org-todo
        "m,"  'org-ctrl-c-ctrl-c
        "mee" 'org-export-dispatch
        "mit" 'org-toggle-inline-images
        "mbm" 'org-babel-mark-block
        "mbt" 'org-babel-tangle
        "mn"  'org-narrow-to-subtree
        "mN"  'widen)

  ; evil-keybinds
  (evil-define-key 'normal org-mode-map
    "gh" 'outline-up-heading
    "gl" 'outline-next-visible-heading
    "gj" 'org-forward-heading-same-level
    "gk" 'org-backward-heading-same-level)

  ; Unbind default keybinds
  (define-key org-src-mode-map (kbd "C-c C-k") nil)
  (define-key org-src-mode-map (kbd "C-c '") nil)

  (evil-define-key 'normal org-src-mode-map
    "ZZ" 'org-edit-src-exit
    "ZQ" 'org-edit-src-abort)

  ;; Custom json babel code-bock type 'json'
  ;; Will just return its contents (passthrough) when evaluated
  ;;; ob-passthrough.el ---  passthrough evaluator          -*- lexical-binding: t; -*-
  (require 'ob)
  (defun org-babel-execute:passthrough (body params)
  body)
  ;; json output is json
  (defalias 'org-babel-execute:json 'org-babel-execute:passthrough)
  (provide 'ob-passthrough)
  ;;; ob-passthrough.el ends here

  ; add python to org-mode babel (allows executing python code in org files src blocks)
  (org-babel-do-load-languages
   'org-babel-load-languages
   '((python . t)
     (shell . t)
     (passthrough . t)))

  :config
  (add-hook 'org-mode-hook
	    (lambda ()
	      (add-hook 'before-save-hook 'org-update-checkbox-count nil 'make-it-local))))
#+end_src

*** Custom org-mode functions
Hide substrees in selected region
#+BEGIN_SRC emacs-lisp
(defun org-hide-subtrees-in-region (beg end)
  (interactive "r")
  (outline-hide-region-body beg end))
#+END_SRC
** Org-download
#+BEGIN_SRC emacs-lisp
(use-package org-download
  :ensure t)
#+END_SRC
** Org-reveal
#+begin_src emacs-lisp
(use-package ox-reveal
  :ensure t
  :init
  (setq org-reveal-root "https://cdn.jsdelivr.net/npm/reveal.js")
  (evil-leader/set-key-for-mode
    'org-mode
    "mert" 'toggle-org-reveal-html-export-on-save
    "merT" 'toggle-org-reveal-current-subtree-html-export-on-save
    "merc" 'org-reveal-export-current-subtree
    "merb" 'org-reveal-export-to-html-and-browse))
#+end_src
** Evil-org
#+BEGIN_SRC emacs-lisp
(use-package evil-org
  :ensure t
  :diminish evil-org-mode
  :after org
  :config
  (add-hook 'org-mode-hook 'evil-org-mode)
  (add-hook 'evil-org-mode-hook
            (lambda ()
            (evil-org-set-key-theme '(navigation insert textobjects additional calendar))))
  (require 'evil-org-agenda)
  (evil-org-agenda-set-keys)
  (evil-define-key 'normal org-mode-map (kbd "RET") 'org-open-at-point))
#+END_SRC
** Edit-indirect
#+BEGIN_SRC emacs-lisp
(use-package edit-indirect
  :ensure t
  :config
  (evil-leader/set-key "m'" 'edit-indirect-region)
  (evil-define-key 'normal edit-indirect-mode-map (kbd "ZZ") 'edit-indirect-commit)
  (evil-define-key 'normal edit-indirect-mode-map (kbd "ZQ") 'edit-indirect-abort))
#+END_SRC
** Comint
#+BEGIN_SRC emacs-lisp
(use-package comint
  :init
  (setq comint-prompt-read-only t)
  (setq comint-scroll-to-bottom-on-output t)
  (evil-collection-comint-setup))
#+END_SRC
** Emacs Desktop
#+BEGIN_SRC emacs-lisp
(desktop-save-mode 1)
#+END_SRC
** Ediff
#+begin_src emacs-lisp
(use-package ediff
  :after evil-collection
  :init
  ; Only highlight current diff
  (setq-default ediff-highlight-all-diffs 'nil)

  ; Turn off whitespace checking
  (setq ediff-diff-options "-w")

  ; Prevent ediff opening seperate emacs window
  (setq ediff-window-setup-function 'ediff-setup-windows-plain)

  ; Bind evil-collection ediff keys
  (evil-collection-ediff-setup))
#+end_src
** Smerge
#+BEGIN_SRC emacs-lisp
(use-package smerge-mode
  :after hydra
  :config
  (defhydra hydra-smerge
    (:color pink :hint nil :post (smerge-auto-leave))
    "
^Move^       ^Keep^               ^Diff^                 ^Other^
^^-----------^^-------------------^^---------------------^^-------
_n_ext       _b_ase               _<_: upper/base        _C_ombine
_p_rev       _u_pper              _=_: upper/lower       _r_esolve
^^           _l_ower              _>_: base/lower        _k_ill current
^^           _a_ll                _R_efine
^^           _RET_: current       _E_diff
"
    ("n" smerge-next)
    ("p" smerge-prev)
    ("b" smerge-keep-base)
    ("u" smerge-keep-upper)
    ("l" smerge-keep-lower)
    ("a" smerge-keep-all)
    ("RET" smerge-keep-current)
    ("\C-m" smerge-keep-current)
    ("<" smerge-diff-base-upper)
    ("=" smerge-diff-upper-lower)
    (">" smerge-diff-base-lower)
    ("R" smerge-refine)
    ("E" smerge-ediff)
    ("C" smerge-combine-with-next)
    ("r" smerge-resolve)
    ("k" smerge-kill-current)
    ("ZZ" (lambda ()
            (interactive)
            (save-buffer)
            (bury-buffer))
     "Save and bury buffer" :color blue)
    ("q" nil "cancel" :color blue))

  ; Mode-specifc evil keybinds
  (evil-define-minor-mode-key 'normal 'smerge-mode " gr" 'hydra-smerge/body))
#+END_SRC
** Image
#+begin_src emacs-lisp
(use-package image-mode
  :after evil-collection
  :init
  (evil-collection-image-setup))
#+end_src
** Restart Emacs
#+BEGIN_SRC emacs-lisp
(use-package restart-emacs
  :ensure t
  :config
  ; define evil ex command :restart to restarts emacs
  (evil-ex-define-cmd "restart" 'restart-emacs))
#+END_SRC
** Scratch
#+begin_src emacs-lisp
(use-package scratch
  :ensure t
  :init
  (evil-leader/set-key
    "bs" 'scratch))
#+end_src
** Which key
#+BEGIN_SRC emacs-lisp
(use-package which-key
  :ensure t
  :after evil
  :diminish which-key-mode
  :init
  (which-key-mode)
  :config
  ; mnemonic - help-whichkey
  (evil-leader/set-key
    "hwt" 'which-key-show-top-level
    "hwf" 'which-key-show-full-keymap))
#+END_SRC
** Projectile
#+BEGIN_SRC emacs-lisp
(use-package projectile
  :ensure t
  :diminish projectile-mode
  :init
  (projectile-mode +1)
  ; enable caching projectile results (used with helm-projectile-find-file)
  (setq projectile-enable-caching t)
  ; set projectile to just use VCS (e.g .gitignore) files during indexing
  (setq projectile-indexing-method 'alien)
  (setq projectile-mode-line "Projectile")
  ; Set ivy as projectile completion-engine
  (setq projectile-completion-system 'ivy)
  (evil-leader/set-key
    "pI" 'projectile-invalidate-cache
    "pd" 'projectile-find-dir))
#+END_SRC
** Ivy
#+begin_src emacs-lisp
(use-package ivy
  :ensure t
  :after evil-collection
  :diminish ivy-mode
  :init
  (ivy-mode 1)

  ; Bind keys
  (define-key ivy-minibuffer-map (kbd "C-c e") 'counsel-edit)
  (define-key ivy-minibuffer-map (kbd "C-c o") 'ivy-occur)
  (define-key ivy-minibuffer-map (kbd "C-<return>") 'ivy-immediate-done)

  (setq ivy-use-virtual-buffers t)
  (setq ivy-count-format "(%d/%d) ")

  (setq ivy-dynamic-exhibit-delay-ms 0)

  (evil-set-initial-state 'ivy-occur-grep-mode 'normal) ; Enable evil mode when entering an ivy-occur-grep-mode buffer
  (evil-collection-ivy-setup))

(defun counsel-edit ()
  "Edit the current search results in a buffer using wgrep. Stolen from spacemacs"
  (interactive)
  (run-with-idle-timer 0 nil 'ivy-wgrep-change-to-wgrep-mode)
  (ivy-occur))
#+end_src
** Ivy-Hydra
#+begin_src emacs-lisp
(use-package ivy-hydra
  :ensure t)
#+end_src
** Wgrep
#+begin_src emacs-lisp
(use-package wgrep
  :ensure t
  :after evil-collection
  :init
  ; save buffer automatically when wgrep-finish-edit
  (setq wgrep-auto-save-buffer t)

  (evil-collection-wgrep-setup))
#+end_src
** Counsel
#+begin_src emacs-lisp
(use-package counsel
  :ensure t
  :diminish counsel-mode
  :init
  (counsel-mode 1)

  (setq counsel-switch-buffer-preview-virtual-buffers nil)

  ; Set fzf default command to use fd instead of find (default)
  (setq counsel-fzf-cmd "fd --type f --color=never --hidden | fzf -f \"%s\"")

  ; Bind counsel evil-leader keys
  (evil-leader/set-key
    ;; Finding files (f)
    ; Find file (ff)
    "ff" 'counsel-find-file ; Current dir file search
    "fF" 'counsel-find-file-region-or-symbol ; Current dir file search

    ; Find file in project (fp)
    "fp" 'counsel-fzf ; Using fzf to implement "Find-file-in-project (fp)"
    "fP" 'counsel-fzf-region-or-symbol

    ;;; Searching (s)
    "sc" 'evil-ex-nohighlight ; clear highlights
    ;; Current file (ss)
    "sj" `counsel-jump-in-buffer ; mnemonic - search-jump (list all symbols in buffer)
    "ss" 'swiper
    "sS" 'swiper-region-or-symbol
    ;; Arbitrary directory (sf)
    "sf" 'counsel-rg-current-dir
    "sF" 'counsel-rg-current-dir-region-or-symbol
    ;; Open buffers (sb)
    "sb" 'swiper-all
    "sB" 'swiper-all-region-or-symbol

    ;; Misc
    "wb" 'switch-to-minibuffer-window
    "hm" 'woman)

  ; Add commands to evil jumplist
  (evil-add-command-properties #'counsel-find-file :jump t)
  (evil-add-command-properties #'counsel-find-file-region-or-symbol :jump t)
  (evil-add-command-properties #'counsel-fzf :jump t)
  (evil-add-command-properties #'counsel-fzf-region-or-symbol :jump t))
#+end_src
** Counsel-projectile
#+begin_src emacs-lisp
(use-package counsel-projectile
  :ensure t
  :init
  (evil-leader/set-key
    "pf" 'counsel-projectile-find-file
    "pF" 'counsel-projectile-find-file-dwim
    "pb" 'counsel-projectile-switch-to-buffer
    "pp" 'counsel-projectile-switch-project
    "sp" 'counsel-projectile-rg-nil-initial-input
    "sP" 'counsel-projectile-rg-region-or-symbol
    "pD" 'projectile-dired
    "pa" 'projectile-toggle-between-implementation-and-test))
#+end_src
** Iedit
#+begin_src emacs-lisp
(use-package iedit
  :ensure t
  :init
  (evil-leader/set-key
    "se" 'evil-iedit-state/iedit-mode))
#+end_src
** Evil-iedit-state
#+begin_src emacs-lisp
(use-package evil-iedit-state
  :ensure t
  :after (iedit evil))
#+end_src
** Expand-region
#+begin_src emacs-lisp
(use-package expand-region
  :ensure t
  :init
  (evil-leader/set-key
    "v" 'er/expand-region)

  (setq expand-region-contract-fast-key "V"
        expand-region-reset-fast-key "r"))
#+end_src
** Smex
#+begin_src emacs-lisp
(use-package smex
  :ensure t)
#+end_src
** Dash-at-point
#+begin_src emacs-lisp
(use-package dash-at-point
  :ensure t
  :init
  ; Bind evil-leader keys
  (evil-leader/set-key
    "dd" 'dash-at-point))
#+end_src
** Rainbow delimiters
#+BEGIN_SRC emacs-lisp
(use-package rainbow-delimiters
  :ensure t
  :hook (prog-mode . rainbow-delimiters-mode))
#+END_SRC
** Company
#+BEGIN_SRC emacs-lisp
(use-package company
  :ensure t
  :after evil-collection
  :diminish company-mode
  :init
  (global-company-mode)

  :config
  ; Set default company backends
  (setq company-backends
        '((company-files          ; files & directory
           company-keywords       ; keywords
           company-capf           ; completion-at-point-functions
           company-abbrev         ; abbreviations
          )))

  (setq company-idle-delay 0.2
        company-minimum-prefix-length 2 ; Show suggestions after entering two characters.
        company-require-match nil
        company-dabbrev-ignore-case nil
        company-dabbrev-downcase nil
        company-selection-wrap-around t); once at bottom of suggestions - wrap back to top

  (evil-collection-company-setup)

  (define-key evil-insert-state-map (kbd "C-j") 'company-select-next)
  (define-key evil-insert-state-map (kbd "C-k") 'company-select-previous))
#+END_SRC
** Company-restclient
#+begin_src emacs-lisp
(use-package company-restclient
  :ensure t
  :after company
  :init
  (add-to-list 'company-backends 'company-restclient))
#+end_src
** Highlight-Indent-Guides
#+BEGIN_SRC emacs-lisp
(use-package highlight-indent-guides
  :ensure t
  :diminish highlight-indent-guides-mode
  :hook (prog-mode . highlight-indent-guides-mode)
  :init
  (setq highlight-indent-guides-method 'character)
  (setq highlight-indent-guides-responsive 'top))
#+END_SRC
** Neotree
#+BEGIN_SRC emacs-lisp
(use-package neotree
  :ensure t
  :after evil-collection
  :bind ("<f8>" . 'neotree-toggle)
  :init
  (evil-leader/set-key "ft" 'neotree-toggle)
  :config
  (evil-collection-neotree-setup) ; Bind evil-collection neotree keys
  (setq neo-window-fixed-size nil)
  (setq neo-theme 'arrow))
#+END_SRC
** Json-mode
#+BEGIN_SRC emacs-lisp
(use-package json-mode
  :ensure t
  :mode "\\.json\\'"
  :init
  (setq json-reformat:indent-width 2))
#+END_SRC
** Yaml-mode
#+begin_src emacs-lisp
(use-package yaml-mode
  :ensure t
  :mode "\\.yaml\\'")
#+end_src
** Flycheck
#+BEGIN_SRC emacs-lisp
(use-package flycheck
  :ensure t
  :diminish flycheck-mode
  :init
  ; flycheck only run if it finds a linter for the buffer language - enabling mode globally is OK
  (global-flycheck-mode)
  (evil-collection-flycheck-setup))
#+END_SRC
** Lsp-mode
#+begin_src emacs-lisp
(use-package lsp-mode
  :ensure t
  :init
  (add-hook 'java-mode-hook #'lsp)
  (setq lsp-enable-symbol-highlighting nil
        lsp-before-save-edits nil))
#+end_src
** Lsp-java
#+BEGIN_SRC elisp
(use-package lsp-java
  :ensure t
  :after lsp-mode
  :init
  (setq lsp-java-format-settings-url "https://raw.githubusercontent.com/google/styleguide/gh-pages/eclipse-java-google-style.xml"
        lsp-java-format-settings-profile "GoogleStyle")

  (add-hook 'java-mode-hook (lambda () (setq c-basic-offset 2))))
#+END_SRC
** Groovy-mode
#+begin_src emacs-lisp
(use-package groovy-mode
  :ensure t
  :mode "\\.groovy\\'")
#+end_src
** Clojure-mode
#+begin_src emacs-lisp
(use-package clojure-mode
  ; The :ensure keyword causes the package(s) to be installed automatically if not already present on your system
  :ensure t

  ; use the :mode keyword to establish a deferred binding within the auto-mode-alist
  ; i.e associate filename patterns (regex) with major mode fns
  :mode (("\\.clj\\'" . clojure-mode)
         ("\\.edn\\'" . clojure-mode))

  ; Use the :init keyword to execute code before a package is loaded
  :init
  ; hooks for minor-modes we want activated before the clojure-mode package is loaded
  (add-hook 'clojure-mode-hook #'rainbow-delimiters-mode)
  (add-hook 'clojure-mode-hook #'smartparens-mode)
  (add-hook 'clojure-mode-hook #'aggressive-indent-mode))
#+end_src
** Cider
#+begin_src emacs-lisp
(use-package cider
  :ensure t
  ; :after keyword delays loading until the dependencies are loaded
  :after clojure-mode


  :init
  (evil-leader/set-key-for-mode 'clojure-mode
    ; Documenation (h)
    "mhh" 'cider-doc
    "mha" 'cider-apropos

    ; Send code to REPL (s)
    "msi" 'cider-jack-in
    "msb" 'cider-load-buffer
    "msB" 'cider-load-buffer-and-switch-to-repl-buffer
    "msx" 'cider-ns-refresh
    "mss" 'cider-switch-to-repl-buffer

    ; Clear (l)
    "ml" (lambda ()
	   (interactive)
       (cider-find-and-clear-repl-output 1)
       (cider-switch-to-repl-buffer))

    ; Format (f)
    "mfb" 'cider-format-buffer

    ; Evauluation (e)
    "mee" 'cider-eval-last-sexp
    "meb" 'cider-eval-buffer
    "mer" 'cider-eval-region)

  (evil-leader/set-key-for-mode 'cider-repl-mode
    ; Documenation (h)
    "mhh" 'cider-doc
    "mha" 'cider-apropos

    ; Send code to REPL (s)
    "msi" 'cider-jack-in
    "msb" 'cider-load-buffer
    "msB" 'cider-load-buffer-and-switch-to-repl-buffer
    "msx" 'cider-ns-refresh
    "mss" 'cider-switch-to-last-clojure-buffer

    ; Clear (l)
    "ml" 'cider-repl-clear-buffer

    ; Evauluation (e)
    "mee" 'cider-eval-last-sexp
    "meb" 'cider-eval-buffer
    "mer" 'cider-eval-region)


  :config
  (evil-collection-cider-setup))
#+end_src
** Smartparens
#+begin_src emacs-lisp
(use-package smartparens
  :ensure t
  :diminish smartparens-mode)
#+end_src
** Aggressive Indent
#+begin_src emacs-lisp
(use-package aggressive-indent
  :ensure t
  :diminish aggressive-indent-mode)
#+end_src
** Python
#+BEGIN_SRC emacs-lisp
(use-package python
  :ensure t
  :mode ("\\.py\\'" . python-mode)
  :interpreter ("python" . python-mode)
  :config
  ; Set python to use ipython as shell interpreter
  (setq python-shell-interpreter "ipython"
	python-shell-interpreter-args "--simple-prompt -c exec('__import__(\\'readline\\')') -i"))
#+END_SRC
** Elpy
#+begin_src emacs-lisp
(use-package elpy
  :ensure t
  :after python
  :diminish elpy-mode
  :defer t
  :init
  ; Defer loading elpy until python-mode loaded
  (advice-add 'python-mode :before 'elpy-enable)

  ; automatically restart inferior python process when python virtual environment changed
  (add-hook 'pyvenv-post-activate-hooks 'pyvenv-restart-python)

  (evil-leader/set-key-for-mode 'python-mode
    "gd" 'elpy-goto-definition
    "msb" 'elpy-shell-send-buffer
    "mfc" 'elpy-black-fix-code)

  ; Pyvenv keybinds
  (evil-leader/set-key-for-mode 'python-mode
    "mva" 'pyvenv-activate
    "mvd" 'pyvenv-deactivate
    "mvw" 'pyvenv-workon)

  :config
   ; Config elpy to use flycheck instead of flymake
  (setq elpy-modules (delq 'elpy-module-flymake elpy-modules))
  (add-hook 'elpy-mode-hook 'flycheck-mode)

  ; Disable "highlight-indentation" elpy module
  (setq elpy-modules (delete 'elpy-module-highlight-indentation elpy-modules))

   ; custon fn to clear elpy shell
  (defun elpy-shell-clear-shell ()
    "Clear the current shell buffer."
    (interactive)
    (with-current-buffer (process-buffer (elpy-shell-get-or-create-process))
      (comint-clear-buffer))))
#+end_src
** Xref
#+begin_src emacs-lisp
(use-package xref
  :init
  (evil-collection-xref-setup))
#+end_src
** Dockerfile-mode
#+begin_src emacs-lisp
(use-package dockerfile-mode
  :ensure t)
#+end_src
** Hl-todo
#+BEGIN_SRC emacs-lisp
(use-package hl-todo
  :ensure t
  ; Bind hl-todo commands to evil keymap. Mnemonic - "goto todo"
  :bind (:map evil-normal-state-map
              ("gt]" . hl-todo-next)
              ("gt[" . hl-todo-previous))
  :init
  ; Add hl-todo next-prev commands to evil jump-list
  (evil-add-command-properties #'hl-todo-next :jump t)
  (evil-add-command-properties #'hl-todo-previous :jump t)
  (global-hl-todo-mode))
#+END_SRC
** Spaceline
#+BEGIN_SRC emacs-lisp
(use-package spaceline
  :ensure t
  :init
  (setq spaceline-highlight-face-func `spaceline-highlight-face-evil-state)
  :config
  (spaceline-emacs-theme))
#+END_SRC
** Diff-hl
#+begin_src emacs-lisp
(use-package diff-hl
  :ensure t
  :config
  (global-diff-hl-mode)

  ; set diff-hl to work with unsaved buffers too
  (diff-hl-flydiff-mode t)

  ; add magit hooks
  (add-hook 'magit-post-refresh-hook 'diff-hl-magit-post-refresh))
#+end_src
** Origami
#+BEGIN_SRC emacs-lisp
(use-package origami
  :ensure t
  :hook (prog-mode . origami-mode))
#+END_SRC
** Terraform
#+BEGIN_SRC emacs-lisp
(use-package terraform-mode
  :ensure t
  :mode "\\.tf\\'")
#+END_SRC
** Editorconfig
#+BEGIN_SRC emacs-lisp
(use-package editorconfig
  :ensure t
  :diminish editorconfig-mode
  :config
  (editorconfig-mode 1))
#+END_SRC
** Magit
#+BEGIN_SRC emacs-lisp
(use-package magit
  :ensure t
  :after evil-magit
  :init
  (evil-leader/set-key
    "gs"  'magit-status
    "gm"  'magit-dispatch
    "gb"  'magit-blame
    "gS"  'magit-stage-file
    "gU"  'magit-unstage-file
    "gfd" 'magit-diff-buffer-file)

  ; When branching off origin/master or master - set upstream to said branch
  (setq magit-branch-adjust-remote-upstream-alist '(("origin/master" "master")))
  ; When branching off master - set upstream to origin/master
  (setq magit-branch-prefer-remote-upstream '("master"))

  ; Show magit status buffer to fullscreen (except when diffing)
  (setq magit-display-buffer-function 'magit-display-buffer-same-window-except-diff-v1)

  ; Enable margin in magit refs
  (setq magit-refs-margin '(t age magit-log-margin-width t 18))

  :config
  ; st opens magit status
  (evil-ex-define-cmd "st" 'magit-status)

  ; magit disables git-clean default - this enables it
  (put 'magit-clean 'disabled nil)

  ; don't prompt for confirmation when staging all changes
  (add-to-list 'magit-no-confirm 'stage-all-changes)

  ; integrate magit with diff-hl - refresh changes on refresh
  (add-hook 'magit-post-refresh-hook 'diff-hl-magit-post-refresh)

  ; Custom fn to invalidate projectile cache on magit checkout
  (defun run-projectile-invalidate-cache (&rest _args)
    ;; Ignore the args to `magit-checkout'.
    (projectile-invalidate-cache nil))
  (advice-add 'magit-checkout
              :after #'run-projectile-invalidate-cache)
  (advice-add 'magit-branch-and-checkout ; This is `b c'.
              :after #'run-projectile-invalidate-cache)

  ; enable quiting magit "transient" pop-ups using q
  (with-eval-after-load 'transient
    (transient-bind-q-to-quit))

  ; Enable automatic refreshing of magit buffers
  (add-hook 'after-save-hook 'magit-after-save-refresh-status t)

  (with-eval-after-load "magit-diff"
    (define-key magit-hunk-section-map (kbd "<return>") 'magit-diff-visit-file-other-window))

  ; Custom fn to get current branch and put on kill ring (copy)
  (defun magit-copy-current-branch-to-clipboard  ()
    "Show the current branch in the echo-area and add it to the `kill-ring'."
    (interactive)
    (let ((branch (magit-get-current-branch)))
      (if branch
	  (progn (kill-new branch)
		 (message "%s" branch))
	(user-error "There is not current branch")))))
#+END_SRC
** Git Timemachine
#+BEGIN_SRC emacs-lisp
(use-package git-timemachine
  :ensure t
  :after evil-collection
  :config
  (evil-collection-git-timemachine-setup)
  ; Bind evil leader keys
  (evil-leader/set-key "gt" 'git-timemachine))
#+END_SRC
** Forge
#+BEGIN_SRC emacs-lisp
(use-package forge
  :ensure t
  :after magit
  :init
  (evil-leader/set-key "gfbr" 'forge-browse-remote))
#+END_SRC
** String-inflection
#+BEGIN_SRC emacs-lisp
(use-package string-inflection
  :ensure t)
#+END_SRC
** Uuidgen
#+begin_src emacs-lisp
(use-package uuidgen
  :ensure t
  :init
  ;; Bind evil-leader keys
  (evil-leader/set-key "iU4" 'uuidgen))
#+end_src
** Yasnippet
#+BEGIN_SRC emacs-lisp
(use-package yasnippet
  :ensure t
  :diminish yas-minor-mode
  :config
  (yas-global-mode 1))

(use-package yasnippet-snippets
  :ensure t
  :after yasnippet)
#+END_SRC
** Impatient mode
#+BEGIN_SRC emacs-lisp
(use-package impatient-mode
  :ensure t
  :init
  (defun markdown-html (buffer)
    (princ (with-current-buffer buffer
	     (format "<!DOCTYPE html><html><title>Impatient Markdown</title><xmp theme=\"united\" style=\"display:none;\"> %s  </xmp><script src=\"http://strapdownjs.com/v/0.2/strapdown.js\"></script></html>" (buffer-substring-no-properties (point-min) (point-max))))
	   (current-buffer)))

  (evil-leader/set-key
    "mIi" (lambda () (interactive)
        (unless (get-process "httpd")
            (message "Starting httpd server...")
            (httpd-start)
            (message nil))
    	(impatient-mode))
    "mIvv"  'imp-visit-buffer
    "mIvm" (lambda () (interactive)
	     (imp-set-user-filter 'markdown-html)
	     (imp-visit-buffer))
    "mIfs" 'imp-set-user-filter
    "mIfr" 'imp-remove-user-filter))
#+END_SRC
** Restclient
#+begin_src emacs-lisp
(use-package restclient
  :ensure t
  :after evil-collection
  :init
  (evil-collection-restclient-setup)

  (evil-leader/set-key-for-mode 'restclient-mode
    "mn" 'restclient-jump-next
    "mp" 'restclient-jump-prev
    "ms" 'restclient-http-send-current-stay-in-window
    "mS" 'restclient-http-send-current
    "mr" 'restclient-http-send-current-raw
    "my" 'restclient-copy-curl-command))
#+end_src
** Ob-Restclient
#+begin_src emacs-lisp
(use-package ob-restclient
  :ensure t
  :after restclient
  :init
  ; Add restclient to org-babel languages
  (org-babel-do-load-languages
   'org-babel-load-languages
   '((restclient . t)))

  ; Associate files with the .http extension with the major mode "restclient-mode"
  (add-to-list 'auto-mode-alist '("\\.http\\'" . restclient-mode)))
#+end_src
** Paradox
#+BEGIN_SRC emacs-lisp
(use-package paradox
   :ensure t)
#+END_SRC
** Misc functions
Reload emacs config
#+BEGIN_SRC emacs-lisp
(defun reload-init-file ()
  (interactive)
  (load-file "~/.emacs.d/init.el"))
#+END_SRC

Open emacs init file
#+BEGIN_SRC emacs-lisp
(defun find-emacs-init-file ()
  "Edit the 'emacs-init-file', in another window."
  (interactive)
  (find-file "~/.emacs.d/init.el.org"))
#+END_SRC

#+BEGIN_SRC emacs-lisp
(defun git-reset-common-ancestor ()
  "Runs external shell command (using compile) which resets to common git commit ancestor"
  (interactive)
  (shell-command "git roa")
  (mmagit-refresh))

#+END_SRC

#+BEGIN_SRC emacs-lisp
(defun git-reset-origin-current-branch ()
  "git reset to origin version of current branch"
  (interactive)
  (shell-command "git rob")
  (magit-refresh))
#+END_SRC

Rename current file/buffer
source: https://sites.google.com/site/steveyegge2/my-dot-emacs-file
#+BEGIN_SRC emacs-lisp
(defun rename-file-and-buffer ()
  "Renames current buffer and file it is visiting."
  (interactive)
  (let* ((name (buffer-name))
        (filename (buffer-file-name))
        (basename (file-name-nondirectory filename)))
    (if (not (and filename (file-exists-p filename)))
        (error "Buffer '%s' is not visiting a file!" name)
      (let ((new-name (read-file-name "New name: " (file-name-directory filename) basename nil basename)))
        (if (get-buffer new-name)
            (error "A buffer named '%s' already exists!" new-name)
          (rename-file filename new-name 1)
          (rename-buffer new-name)
          (set-visited-file-name new-name)
          (set-buffer-modified-p nil)
          (message "File '%s' successfully renamed to '%s'"
                   name (file-name-nondirectory new-name)))))))
#+END_SRC

Delete file and buffer
"Borrowed" from spacemacs
#+begin_src emacs-lisp
(defun delete-current-buffer-file ()
  "Removes file connected to current buffer and kills buffer."
  (interactive)
  (let ((filename (buffer-file-name))
        (buffer (current-buffer))
        (name (buffer-name)))
    (if (not (and filename (file-exists-p filename)))
        (ido-kill-buffer)
      (when (yes-or-no-p "Are you sure you want to delete this file? ")
        (delete-file filename t)
        (kill-buffer buffer)
        (when (projectile-project-p)
          (call-interactively #'projectile-invalidate-cache))
        (message "File '%s' successfully removed" filename)))))
#+end_src

Disable all minor modes in current buffer
#+BEGIN_SRC emacs-lisp
(defun disable-all-minor-modes ()
  (interactive)
  (mapc
   (lambda (mode-symbol)
     (when (functionp mode-symbol)
       ;; some symbols are functions which aren't normal mode functions
       (ignore-errors
         (funcall mode-symbol -1))))
     minor-mode-list))
#+END_SRC

Fn to revert current buffer w/o prompting for confirmation
#+BEGIN_SRC emacs-lisp
;; Source: http://www.emacswiki.org/emacs-en/download/misc-cmds.el
(defun revert-buffer-no-confirm ()
    "Revert buffer without confirmation."
    (interactive)
    (revert-buffer :ignore-auto :noconfirm))
#+END_SRC

Switch to minibuffer window
#+BEGIN_SRC emacs-lisp
(defun switch-to-minibuffer-window ()
  "switch to minibuffer window (if active)"
  (interactive)
  (when (active-minibuffer-window)
    (select-window (active-minibuffer-window))))
#+END_SRC

Fn to call imenu/semantic/org-goto depending on mode
Pinched from spacemacs
#+begin_src emacs-lisp
(defun counsel-jump-in-buffer ()
  "Jump in buffer using imenu or semantic or org-goto"
  (interactive)
  (call-interactively
   (cond
    ((eq major-mode 'org-mode) 'counsel-org-goto)
    (t 'counsel-semantic-or-imenu))))
#+end_src

Kill all buffers except current
Borrowed from spacemacs
#+begin_src emacs-lisp
(defun kill-other-buffers (&optional arg)
  "Kill all other buffers.
  If the universal prefix argument is used then will the windows too."
  (interactive "P")
  (when (yes-or-no-p (format "Killing all buffers except \"%s\"? "
                             (buffer-name)))
    (mapc 'kill-buffer (delq (current-buffer) (buffer-list)))
    (when (equal '(4) arg) (delete-other-windows))
    (message "Buffers deleted!")))
#+end_src

Fn to toggle auto exporting reveal.js html pages on save
#+begin_src emacs-lisp
(defun toggle-org-reveal-html-export-on-save ()
  (interactive)
  (if (memq 'org-reveal-export-to-html after-save-hook)
      (progn
        (remove-hook 'after-save-hook 'org-reveal-export-to-html t)
        (message "Disabled org html export on save for current buffer..."))
    (add-hook 'after-save-hook 'org-reveal-export-to-html nil t)
    (message "Enabled org html export on save for current buffer...")))
#+end_src

Fn to toggle auto exporting current org subtree to reveal.js on save
#+begin_src emacs-lisp
(defun toggle-org-reveal-current-subtree-html-export-on-save ()
  (interactive)
  (if (memq 'org-reveal-export-current-subtree after-save-hook)
      (progn
        (remove-hook 'after-save-hook 'org-reveal-export-current-subtree t)
        (message "Disabled org html export current subtree on save for current buffer..."))
    (add-hook 'after-save-hook 'org-reveal-export-current-subtree nil t)
    (message "Enabled org html export current subtree on save for current buffer...")))
#+end_src

Run swiper with currently selected region or symbol
#+begin_src emacs-lisp
(defun swiper-region-or-symbol ()
  "Run `swiper' with the selected region or the symbol
  around point as the initial input."
  (interactive)
  (let ((input (if (region-active-p)
                   (buffer-substring-no-properties
                    (region-beginning) (region-end))
                 (thing-at-point 'symbol t))))
    (evil-magit-maybe-deactivate-mark)
    (swiper input)))
#+end_src

Run swiper-all with currently selected region or symbol
#+begin_src emacs-lisp
(defun swiper-all-region-or-symbol ()
  "Run `swiper-all' with the selected region or the symbol
  around point as the initial input."
  (interactive)
  (let ((input (if (region-active-p)
                   (buffer-substring-no-properties
                    (region-beginning) (region-end))
                 (thing-at-point 'symbol t))))
    (evil-magit-maybe-deactivate-mark)
    (swiper-all input)))
#+end_src

Run counsel-rg with currently selected region or symbol
#+begin_src emacs-lisp
(defun counsel-rg-current-dir-region-or-symbol ()
  "Run `counsel-rg' with the selected region or the symbol
  around point as the initial input."
  (interactive)
  (let ((input (if (region-active-p)
                   (buffer-substring-no-properties
                    (region-beginning) (region-end))
                 (thing-at-point 'symbol t))))
    (evil-magit-maybe-deactivate-mark)
    (counsel-rg input (symbol-value 'default-directory) nil)))
#+end_src

#+begin_src emacs-lisp
(defun counsel-rg-current-dir ()
  (interactive)
  (counsel-rg nil (symbol-value 'default-directory) nil))
#+end_src

Run counsel-projectile-rg with currently selected region or symbol
#+begin_src emacs-lisp
(defun counsel-projectile-rg-region-or-symbol ()
  "Run `counsel-projectile-rg' with the selected region or the symbol
  around point as the initial input."
  (interactive)
  (let ((input (if (region-active-p)
                   (buffer-substring-no-properties
                    (region-beginning) (region-end))
                 (thing-at-point 'symbol t))))
    (evil-magit-maybe-deactivate-mark)
    (setq counsel-projectile-rg-initial-input input)
    (counsel-projectile-rg)))
#+end_src


Run counsel-find-file with currently selected region or symbol
#+begin_src emacs-lisp
(defun counsel-find-file-region-or-symbol ()
  "Run `counsel-find-file' with the selected region or the symbol
  around point as the initial input."
  (interactive)
  (let ((input (if (region-active-p)
                   (buffer-substring-no-properties
                    (region-beginning) (region-end))
                 (thing-at-point 'symbol t))))
    (evil-magit-maybe-deactivate-mark)
    (counsel-find-file input)))
#+end_src

Wrapper fn over counsel-projectile-rg - sets initial input of the command to nil before invoking
#+begin_src emacs-lisp
(defun counsel-projectile-rg-nil-initial-input ()
  "Run `counsel-projectile-rg' with the selected region or the symbol
  around point as the initial input. Also set initial input to nil before invoking"
  (interactive)
  (setq counsel-projectile-rg-initial-input nil)
  (counsel-projectile-rg))
#+end_src

Run counsel-fzf with currently selected region or symbol
#+begin_src emacs-lisp
(defun counsel-fzf-region-or-symbol ()
  "Run `counsel-fzf' with the selected region or the symbol
  around point as the initial input."
  (interactive)
  (let ((input (if (region-active-p)
                   (buffer-substring-no-properties
                    (region-beginning) (region-end))
                 (thing-at-point 'symbol t))))
    (evil-magit-maybe-deactivate-mark)
    (counsel-fzf input)))
#+end_src

Show and copy current file absolute path in the minibuffer - stolen from spacemacs
#+begin_src emacs-lisp
(defun show-and-copy-buffer-file-abs-path ()
  "Show and copy the full path to the current file in the minibuffer."
  (interactive)
  ;; list-buffers-directory is the variable set in dired buffers
  (let ((file-name (or (buffer-file-name) list-buffers-directory)))
    (if file-name
        (message (kill-new file-name))
      (error "Buffer not visiting a file"))))
#+end_src

Copy name of current file to clipboard
#+begin_src emacs-lisp
(defun copy-file-name-to-clipboard ()
  "Copy the current buffer file name to the clipboard."
  (interactive)
  (let ((filename (if (equal major-mode 'dired-mode)
                      default-directory
                    (buffer-name))))
    (when filename
      (kill-new filename))
    (message filename)))
#+end_src

Toggle maximize buffer
#+begin_src emacs-lisp
;; from https://gist.github.com/3402786
(defun toggle-maximize-buffer ()
  "Maximize buffer"
  (interactive)
  (if (and (= 1 (length (window-list)))
           (assoc ?_ register-alist))
      (jump-to-register ?_)
    (progn
      (window-configuration-to-register ?_)
      (delete-other-windows))))

#+end_src

Start a sqli process with given sql-product (e.g postgres, mysql)
#+begin_src emacs-lisp
(defun sql-start ()
    "set SQL dialect-specific highlighting and start inferior SQLi process"
    (interactive)
    (sql-set-product (sql-read-product "SQL product: " (intern "postgres")))
    (sql-product-interactive))
#+end_src

Alternate window
Borrowed from spacemacs
#+begin_src emacs-lisp
(defun alternate-window ()
  "Switch back and forth between current and last window in the
current frame."
  (interactive)
  (let (;; switch to first window previously shown in this frame
        (prev-window (get-mru-window nil t t)))
    ;; Check window was not found successfully
    (unless prev-window (user-error "Last window not found."))
    (select-window prev-window)))
#+end_src

Window rotation functions
Borrowed from spacemacs
#+begin_src emacs-lisp
(defun rotate-windows-forward (count)
  "Rotate each window forwards.
  A negative prefix argument rotates each window backwards.
  Dedicated (locked) windows are left untouched."
  (interactive "p")
  (let* ((non-dedicated-windows (cl-remove-if 'window-dedicated-p (window-list)))
         (states (mapcar #'window-state-get non-dedicated-windows))
         (num-windows (length non-dedicated-windows))
         (step (+ num-windows count)))
    (if (< num-windows 2)
        (error "You can't rotate a single window!")
      (dotimes (i num-windows)
        (window-state-put
         (elt states i)
         (elt non-dedicated-windows (% (+ step i) num-windows)))))))

(defun rotate-windows-backward (count)
  "Rotate each window backwards.
Dedicated (locked) windows are left untouched."
  (interactive "p")
  (rotate-windows-forward (* -1 count)))

#+end_src

#+begin_src emacs-lisp
(defun split-window-below-and-focus ()
"Split the window vertically and focus the new window."
    (interactive)
    (split-window-below)
    (windmove-down)
    (when (and (boundp 'golden-ratio-mode)
                (symbol-value golden-ratio-mode))
        (golden-ratio)))


(defun split-window-right-and-focus ()
    "Split the window horizontally and focus the new window."
    (interactive)
    (split-window-right)
    (windmove-right)
    (when (and (boundp 'golden-ratio-mode)
                (symbol-value golden-ratio-mode))
    (golden-ratio)))


(defun shrink-window-horizontally (delta)
  (interactive "p")
  (shrink-window delta t))

(defun shrink-window-vertically (delta)
  (interactive "p")
  (shrink-window delta))

(defun enlarge-window-vertically (delta)
  (interactive "p")
  (enlarge-window delta))

(defun enlarge-window-horizontally (delta)
  (interactive "p")
  (enlarge-window delta t))
#+end_src
